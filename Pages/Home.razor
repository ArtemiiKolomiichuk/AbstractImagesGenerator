@page "/"
<a href="/gen">
    Generate    
</a>

<h1>Gallery</h1>
@foreach (var (id, image) in gallery)
{
    <div @onclick="() => {
            NavigationManager.NavigateTo(uri + id);
        }">
        <img src="@image" />
    </div>
}

@using Newtonsoft.Json;
@inject NavigationManager NavigationManager
@code {
    private const string uri = "/gen/gallery:";
    List<(string id, string image)> gallery = [];

    protected override async Task OnInitializedAsync()
    {
        var client = new HttpClient();
        var response = await client.GetAsync(Program.BaseApiUrl + "/template-query/all?include_metadata=true&include_image=true&full_metadata=false");
        if (response.IsSuccessStatusCode)
        {
            var parser = HttpMultipartParser.MultipartFormDataParser.Parse(await response.Content.ReadAsStreamAsync());
            for (int i = 0; i < parser.Files.Count; i += 2)
            {
                Stream imageStream = parser.Files[i].Data;
                Stream jsonStream = parser.Files[i + 1].Data;
                var json = new StreamReader(jsonStream).ReadToEnd();
                var id = JsonConvert.DeserializeObject<Dictionary<string, string>>(json)?["template_query_id"];
                if (id != null)
                    gallery.Add((id, $"data:image/jpg;base64,{Convert.ToBase64String(imageStream.ReadFully())}"));
            }
            StateHasChanged();
        }
    }
}
